---
title: "Extracting Climate Statistics from Spatial Data - Tutorial"
output: html_document
---
#### Note 
This tutorial was created to help students interested in developing their skills in GIS and R.
#### Goal 
Familiarize yourself with R Studio by mapping and visualizing climate data. You will be working with WorldClim global climate data (temperature and precipitation) with a special focus on subsetting data to Mongolia. You can read more about this dataset at http://www.worldclim.org/.
####	Getting the data 
If you are downloading the tutorial and data from Github you should follow these steps to more easily access data and run through the code provided.
<br />
1)	Create a folder in your "C:/" drive called “Tutorial”.<br />
2)	Download the *climate_tutorial.zip* file and unzip the contents to the *Tutorial* folder.<br />
3) Make sure that the filepath to the data is C:/Tutorial/climate_tutorial or set your own working directory.
4)	Unpack all .bil, .hdr, and .tif files to the *climate_tutorial* folder
<br /><br />
Files included: <br />
*Ecoregion shapefiles (ecoregion)* <br />
*Monthly precipitation rasters (prec_19)* <br />
*Mean monthly temperature rasters (tmean_10m_bil)* <br />
<br />
```{r knit, include = FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

```{r packages, include = FALSE, message = FALSE, warning = FALSE}

list.of.packages <- c("rmarkdown", "ggplot2","raster", "rgdal", "sp", "reshape2", "rasterVis")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

```

#### Required libraries

```{r load libraries, include = TRUE, message = FALSE, warning = FALSE}

# If you don't have these libraries, you will need to run install.packages("LIBRARYNAME") to download them. I have included a function in the R file tutorial that should automatically download the libraries for you.

library(raster)
library(sp)
library(rgdal)
library(ggplot2)
library(reshape2)
library(rasterVis)
library(RColorBrewer)
library(maps)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)

```

```{r choose file, include = FALSE}

#wd <- choose.dir()
#wd <- "C:/Users/niko8816/Desktop/Tools/R/climateTutorial"
#setwd(wd)
#print(wd)

```
<br />

#### Set working directory

setwd("C:/Tutorial/ClimateTutorial")

<br />

#### Loading spatial data

Get the GADM administrative boundary shapefile for Mongolia

```{r load mongolia admin, echo=TRUE}

b <- getData('GADM', country='MNG', level=0) #Level0=country, MNG is Mongolia
aimag <- getData('GADM', country='MNG', level=1) #Level1=aimag, these are like US states
plot(aimag)

```

#### While data is already included in the tutorial zip folder, you can download 'WorldClim' bio data directly from the {raster} package server.

```{r worldclim, echo = TRUE}

r <- getData("worldclim", var="bio", res=10) # Resultion is 10 arc second (~1km)
bio <- r[[c(1,12)]] # Bio 1 (Mean Annual Temperature) and Bio 12 (Annual Precipitation)
names(bio) <- c("Temp","Prec")

world <- ne_countries(scale = "medium", returnclass = "sf")

# Plot temperature
plot(bio$Temp, main = "Mean Annual Temperature [C*10] (2009-2018)", xlab = "Longitude", ylab = "Latitude")
map("world", lwd = 0.5, col = "white", add = TRUE)

# Give the map an interesting color ramp
preccol = brewer.pal(5, "YlGnBu")
pal <- colorRampPalette(preccol)

# Plot precipitation
plot(bio$Prec, main="Mean Annual Precipitation (2009-2018)", xlab = "Longitude", ylab = "Latitude")
map("world", lwd = 0.5, col = "white", add=TRUE)


```

Get shapefiles of ecoregions from the "climate_tutorial/ecoregions" folder

```{r grass shapefile, echo = TRUE}

grass <- readOGR(dsn = "C:/Users/niko8816/Desktop/Tools/R/climateTutorial/data", layer = "grassland")

```

```{r ecoregion shapefiles, include = TRUE, echo = FALSE, message = FALSE, warning = FALSE}

mount <- readOGR(dsn = "C:/Users/niko8816/Desktop/Tools/R/climateTutorial/data", layer = "mountain_steppe")
basin <- readOGR(dsn = "C:/Users/niko8816/Desktop/Tools/R/climateTutorial/data", layer = "terminal_basin")

# Transform shapefiles to be the same projection as WorldClim data
grass.trans <- spTransform(grass, CRS("+proj=longlat +datum=WGS84")) 
mount.trans <- spTransform(mount, CRS("+proj=longlat +datum=WGS84"))
basin.trans <- spTransform(basin, CRS("+proj=longlat +datum=WGS84"))

# Crop/clip WorldClim data to Mongolia boundary/extent
crop <- crop(bio, b)

```

<br />

Take a look at Grassland and Terminal Basin ecoregion shapefiles on top of the Temperature raster

```{r plot 1}

plot(crop$Temp, legend = FALSE, xaxt = 'n', yaxt = 'n')
plot(grass.trans, add=TRUE)
plot(basin.trans, add=TRUE)

```

#### Creating Sample Points

Let's create random sample points within the Mongolia boundary just to look at what information we can extract with them. Then we we plot the map of Worldclim temperature data, Monogolia boundary, and the new sample points.

```{r plot points}

points <- spsample(as(b, 'SpatialPolygons'),n=100, type="random")

plot(crop[["Temp"]])
plot(b, add=TRUE)
plot(points, add=TRUE)

```

Let's create random sample points within the **Mountain Steppe** ecoregion just to look at them and plot them over the precipitation raster.

```{r plot mountains}
mount.points <- spsample(as(mount.trans, 'SpatialPolygons'),n=100, type="random")

plot(crop[["Prec"]])
plot(mount.trans, add=TRUE)
plot(mount.points, add=TRUE)

```

Now create a data table of values extracted from random points throughout all of Mongolia

```{r load df}
values <- extract(bio, points) # Extract Temp and Precip values from the points
df <- cbind.data.frame(coordinates(points),values) # Creates table of point coordinates and values
head(df) # Just show the top few values of table.

```

You can see the point coordinates with the temperature and precipitation values extracted at each point.

<br />

Now plot all values with regression line to see how Precipitation decreases as Temperature increases

```{r plot regression line, echo = FALSE}

plot(df$Temp, df$Prec, xlab = "Temperature", ylab =  "Precipitation") + abline(lm(df$Prec~df$Temp), col="red") 

```

#### MONTHLY MEAN TEMPERATURE

Now let's visualize monthly climate values.

```{r load rasters}

mJan <- raster("tmean1.bil") #mean temp for January etc.
mFeb <- raster("tmean2.bil")
mMar <- raster("tmean3.bil")
mApr <- raster("tmean4.bil")
mMar <- raster("tmean5.bil")
mJun <- raster("tmean6.bil")
mJul <- raster("tmean7.bil")
mAug <- raster("tmean8.bil")
mSep <- raster("tmean9.bil")
mOct <- raster("tmean10.bil")
mNov <- raster("tmean11.bil")
mDec <- raster("tmean12.bil")

```

Here is the mean temperature for July and January. Notice the shift.

```{r plot raster}

tempcol <- colorRampPalette(c("purple", "blue", "skyblue", "green", "lightgreen", "yellow", "orange", "red", "darkred"))

plot(mJul, col=tempcol(100))
plot(mJan, col=tempcol(100))

```

<br />
Stack the separate tiles into a single image
<br />

```{r stack}

mstack <- stack(mJan, mFeb, mMar, mApr, mMar, mJun, mJul, mAug, mSep, mOct, mNov, mDec)
cutStack <- (crop(mstack, b))/10 # crop to Mongolia shapefile
names(cutStack) <- month.abb # Names stacks by month

```

Plot and create histogram of mean temperature ranges by month.

```{r levelplot}

levelplot(cutStack, col.regions=topo.colors) + layer(sp.polygons(b))

histogram(cutStack) # Notice how temperature shifts throughout the year

```
<br />

### MONTHLY PRECIPITATON

Open WorldClim monthly precipitation tiles

```{r precipitation}

pJan <- raster("prec_01.tif")
pFeb <- raster("prec_02.tif")
pMar <- raster("prec_03.tif")
pApr <- raster("prec_04.tif")
pMay <- raster("prec_05.tif")
pJun <- raster("prec_06.tif")
pJul <- raster("prec_07.tif")
pAug <- raster("prec_08.tif")
pSep <- raster("prec_09.tif")
pOct <- raster("prec_10.tif")
pNov <- raster("prec_11.tif")
pDec <- raster("prec_12.tif")

# Give the map an interesting color ramp
preccol = brewer.pal(5, "YlGnBu")
pal <- colorRampPalette(preccol)

# Take a look!
plot(pFeb, col=pal(100))
plot(b, add=TRUE)

```

```{r}
# Stack separate tiles into a single image
pstack <- stack(pJan, pFeb, pMar, pApr, pMar, pJun, pJul, pAug, pSep, pOct, pNov, pDec)
putStack <- (crop(pstack, b))/10 # crop to Mongolia shapefile
names(putStack) <- month.abb

# Again, see the difference in precipitation between January and July
plot(putStack$Jan, col=pal(100))
plot(b, add=TRUE)
plot(putStack$Jul, col=pal(100))
plot(b, add=TRUE)

# Plot and create histogram of mean temperature ranges by month
levelplot(putStack, col.regions=pal)
```

Notice the dry Mongolian winters, and (relatively) wet summers.

```{r}
histogram(putStack)
```

#### TEMPERATURE BY ECOREGION

Next you can extract the temperature data from each ecoregion polygon to view differences between them

```{r}

grassMean <- extract(cutStack, grass.trans)[[1]]
mountMean <- extract(cutStack, mount.trans)[[1]]
basinMean <- extract(cutStack, basin.trans)[[1]]

n <- dim(grassMean)[1] #for sampling convenience
m <- dim(mountMean)[1]
l <- dim(basinMean)[1]

grassMat <- grassMean[sample(n, 10),] #this is the final extracted data
mountMat <- mountMean[sample(m, 10),]
basinMat <- basinMean[sample(l, 10),]

# This code creates the table style using ggplot2
plotter <- data.frame(rbind(grassMat, mountMat, basinMat), region = c(rep("Grass",10), rep("Mount",10), rep("Basin",10)))
forplo <- melt(plotter)
g1 <- ggplot(forplo, aes(x = value, fill = region)) + geom_histogram() + facet_grid(variable~.)

```

The plot shows the range of temperature in each ecoregion.
You can see that the Mountain Steppe is the coolest region, while the Terminal Basin is the hottest with the most diverse range

```{r, include=TRUE, echo = TRUE}

plot(g1)

```

<br />

#### PRECIPITATION BY ECOREGION

Now let's look at precipitation differences

```{r, include = FALSE, echo = TRUE}
grassPM <- extract(putStack, grass.trans)[[1]]
mountPM <- extract(putStack, mount.trans)[[1]]
basinPM <- extract(putStack, basin.trans)[[1]]

o <- dim(grassPM)[1] #for sampling convenience
p <- dim(mountPM)[1]
q <- dim(basinPM)[1]

grassPrep <- grassPM[sample(o, 100),] #this is the final extracted data
mountPrep <- mountPM[sample(p, 10),]
basinPrep <- basinPM[sample(q, 10),]

prep.plotter <- data.frame(rbind(grassPrep, mountPrep, basinPrep), region = c(rep("Grass",10), rep("Mount",10), rep("Basin",10)))
porplo <- melt(prep.plotter)
g2 <- ggplot(porplo, aes(x = value, fill = region)) + geom_histogram() + facet_grid(variable~.)

```

<br />
Now you can see that There is mostly NO precipitation in December-Februrary. Summer precipitation is high but infrequent.

```{r, echo = FALSE}
plot(g2)
```
